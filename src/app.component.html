<div class="min-h-screen container mx-auto p-4 md:p-8">
  @if (trackerData(); as data) {
    <!-- Initiative Tracker View -->
    <div class="max-w-4xl mx-auto">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-5xl font-dnd-header text-red-900">Round {{ data.round }}</h1>
        <button (click)="reset()" class="px-4 py-2 bg-red-800 hover:bg-red-700 rounded-lg shadow-md transition-colors duration-200 text-white border border-red-950">
          Disconnect
        </button>
      </header>

      <section class="space-y-3">
        @for (creature of data.creatures; track creature.id) {
          <div 
            class="flex items-center justify-between p-4 rounded-lg bg-stone-500/10 border transition-all duration-300"
            [class.border-amber-600]="creature.isActive"
            [class.border-2]="creature.isActive"
            [class.border-stone-400/50]="!creature.isActive"
            [class.shadow-amber-600/30]="creature.isActive"
            [class.shadow-lg]="creature.isActive"
            [class.scale-105]="creature.isActive"
            [class.opacity-50]="creature.woundInfo?.text === 'Defeated'"
            [class.opacity-75]="!creature.isActive && creature.woundInfo?.text !== 'Defeated'"
            >
            <div class="flex items-center gap-4">
              <div class="text-3xl font-bold text-stone-600 w-10 text-center flex-shrink-0">{{ creature.initiative ?? '--' }}</div>
              
              <div class="w-8 h-8 flex-shrink-0">
                @if (creature.isPlayer) {
                  <!-- Heroicon: user-circle -->
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-blue-800">
                    <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" />
                  </svg>
                } @else {
                  <!-- Monster Icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-red-800">
                    <path fill-rule="evenodd" d="M11.233 2.25c.786 0 1.5.56 1.626 1.332l.332 2.003a.75.75 0 0 0 .933.623c.836-.23 1.696.02 2.295.62l1.385 1.385c.5.5.653 1.285.38 1.972l-.994 2.486a.75.75 0 0 0 .23.82l1.92 1.92a1.688 1.688 0 0 1 0 2.388l-1.92 1.92a.75.75 0 0 0-.23.82l.994 2.486c.273.687.12 1.472-.38 1.972l-1.385 1.385c-.6.6-1.458.85-2.295.62a.75.75 0 0 0-.933.623l-.332 2.003c-.126.772-.84 1.332-1.626 1.332H8.767c-.786 0-1.5-.56-1.626-1.332l-.332-2.003a.75.75 0 0 0-.933-.623c-.836.23-1.696-.02-2.295-.62L2.2 19.33c-.5-.5-.653-1.285-.38-1.972l.994-2.486a.75.75 0 0 0-.23-.82L.664 12.128a1.688 1.688 0 0 1 0-2.388l1.92-1.92a.75.75 0 0 0 .23-.82L1.82 4.514c-.273-.687-.12-1.472.38-1.972L3.585 1.157c.6-.6 1.458.85 2.295-.62a.75.75 0 0 0 .933-.623l.332-2.003C7.267 2.81 7.98 2.25 8.767 2.25h2.466ZM12 15.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z" clip-rule="evenodd" />
                  </svg>
                }
              </div>

              <div class="flex items-center gap-3">
                <p class="text-xl font-bold"
                  [class.line-through]="creature.woundInfo?.text === 'Defeated'"
                  [class.text-stone-600]="creature.woundInfo?.text === 'Defeated'"
                  [class.text-blue-900]="creature.isPlayer && creature.woundInfo?.text !== 'Defeated'"
                  [class.text-red-900]="!creature.isPlayer && creature.woundInfo?.text !== 'Defeated'">
                  {{ creature.name }}
                </p>
                @if(creature.woundInfo; as woundInfo) {
                  <span 
                    class="inline-flex items-center gap-1.5 px-2.5 py-0.5 text-xs font-semibold rounded-full shadow border"
                    [class]="woundInfo.colorClass"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5">
                      <path fill-rule="evenodd" [attr.d]="woundInfo.icon" clip-rule="evenodd" />
                    </svg>
                    {{ woundInfo.text }}
                  </span>
                }
              </div>
            </div>

            <div class="flex flex-wrap gap-2 justify-end">
              @for (effect of creature.statusEffects; track effect.name) {
                <span 
                  class="px-2 py-1 text-white text-xs font-medium rounded-full shadow border border-black/20"
                  [style.background-color]="effect.color"
                >
                  {{ effect.name }}
                </span>
              }
            </div>
          </div>
        }
      </section>
    </div>
  } @else {
    <!-- Connection View -->
    <div class="max-w-md mx-auto text-center">
      <header class="mb-8">
        <h1 class="text-6xl font-dnd-header text-red-900 mb-2">Initiative Player View</h1>
        <p class="text-lg text-stone-700">Connect to your DM's 5e.tools session.</p>
      </header>

      <main class="bg-stone-300/30 p-6 rounded-xl shadow-lg border border-stone-400">
        <div class="mb-4">
          <label for="roomId" class="block text-left text-sm font-bold text-stone-800 mb-2">
            DM's Room ID
          </label>
          <input 
            id="roomId" 
            type="text"
            class="w-full p-3 bg-stone-50 border border-stone-400 rounded-md focus:ring-2 focus:ring-amber-600 focus:border-amber-600 transition-colors text-stone-900 font-mono text-lg shadow-inner"
            [ngModel]="roomId()"
            (ngModelChange)="roomId.set($event)"
            (keyup.enter)="connect()"
            placeholder="Enter Room ID...">
        </div>

        @if (errorMessage()) {
          <div class="my-4 p-3 bg-red-200 border border-red-400 text-red-900 rounded-md text-left">
            <p>{{ errorMessage() }}</p>
          </div>
        }

        @if (connectionState() === 'connecting' || connectionState() === 'waiting') {
          <div class="my-4 p-3 bg-blue-200 border border-blue-400 text-blue-900 rounded-md text-left flex items-center">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            @if(connectionState() === 'connecting') {
                <p>Connecting to server...</p>
            } @else {
                <p>Connected! Waiting for DM's data...</p>
            }
          </div>
        }
        
        <button (click)="connect()" [disabled]="connectionState() === 'connecting' || connectionState() === 'waiting' || !roomId()" class="w-full py-3 px-4 bg-red-800 hover:bg-red-700 rounded-lg text-white font-semibold text-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105 disabled:bg-stone-500 disabled:cursor-not-allowed disabled:scale-100 border border-red-950">
          Connect
        </button>

        <div class="mt-6 text-left text-sm text-stone-600">
          <p class="font-semibold mb-2 text-stone-700">How to get the Room ID:</p>
          <ol class="list-decimal list-inside space-y-1">
            <li>Your DM needs to be using the Initiative Tracker on 5e.tools.</li>
            <li>DM clicks the "Player View" button in the tracker.</li>
            <li>A link will be generated, e.g., <code class="bg-stone-300 px-1 rounded text-xs text-stone-800">...#AbcDeFg</code></li>
            <li>The Room ID is the part after the <code class="bg-stone-300 px-1 rounded text-xs text-stone-800">#</code> symbol.</li>
          </ol>
        </div>
      </main>
    </div>
  }
</div>
